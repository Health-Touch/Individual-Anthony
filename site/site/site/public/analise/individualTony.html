<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/individualTony.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Análise Rede | Health Touch</title>
    <link rel="shortcut icon" type="imagex/png" href="./assets/img/logo_icon.png" />
</head>

<body>

    <div class="divPai">
        <!-- inicio menu lateral -->
        <div class="divPaiLateral">
            <div class="filhoLateral">

                <div class="divNomeEmpresa">

                    <p id="textoEmpresa">Bem Vindo</p>
                    <p id="nomeEmpresa"></p>
                </div>

                <div class="divMainMenu">
                    <p id="pMainMenu">MAIN MENU</p>
                </div>

                <div class="divPaiOpcoesMenu">
                    <a href="../setores.html" id="pMenuLateral">
                        <div class="divHome">
                            <img id="iconMenuLateralHome" src="../assets/img/grafico-de-setores.png">
                            <div class="divEspaco"></div>
                            Setores
                        </div>
                    </a>

                    <a href="../cadastro/cadastroMaquinas.html" id="pMenuLateral">
                        <div class="divComputador">
                            <img id="iconComputadorLateral" src="../assets/img/computador (4).png">
                            <div class="divEspaco"></div>
                            Cadastro Máquinas
                        </div>
                    </a>

                    <a href="../analise/analiseMaquinaTI.html" id="pMenuLateral">
                        <div class="divCadastroComputador">
                            <img id="iconComputadorCadLateral" src="../assets/img/definicoes.png">
                            <div class="divEspaco"></div>
                            Análise Máquinas
                        </div>
                    </a>

                    <a href="../cadastro/cadastroFuncionarios.html" id="pMenuLateral">
                        <div class="divAnaliseEquipe">
                            <img id="iconAnaliseEquipe" src="../assets/img/carteira-de-identidade.png">
                            <div class="divEspaco"></div>
                            Cadastro Equipe
                        </div>
                    </a>

                    <a href="../analise/analiseFuncionario.html" id="pMenuLateral">
                        <div class="divDashboards">
                            <img id="iconDashboardsLateral" src="../assets/img/equipe.png">
                            <div class="divEspaco"></div>
                            Análise Funcionários
                        </div>
                    </a>

                    <a href="" id="pMenuLateral">
                        <div class="divCadastroEquipe">
                            <img id="iconCadastroEquipe" src="../assets/img/mais (2).png">
                            <div class="divEspaco"></div>
                            Dashboards
                        </div>
                    </a>
                </div>

                <div class="divEspacoV2"></div>

                <div class="divHelp">
                    <p id="pHelp">HELP</p>
                </div>

                <div class="divPaiHelpMenu">
                    <a href="../suporte/SuporteHealthTooch.html" id="pMenuLateral">
                        <div class="divHelpDesk">
                            <img id="iconHelpDesk" src="../assets/img/suporte-ao-cliente.png">
                            <div class="divEspaco"></div>
                            HelpDesk
                        </div>
                    </a>
                    <a href="../atualizar/AtualizarUser.html" id="pMenuLateral">
                        <div class="divConfiguracoes">
                            <img id="iconConfiguracoes" src="../assets/img/botao-de-roda-dentada-de-configuracoes.png">
                            <div class="divEspaco"></div>
                            Configurações
                        </div>
                    </a>
                    <a href="../index.html">
                        <img id="logoMenuLateral" src="../assets/img/logoMenu.png">
                    </a>
                </div>
            </div>
        </div>
        <!-- fim do menu lateral -->

        <!-- inicio do cabeçalho -->
        <div class="divPaiCabecalho">
            <div class="filhoCabecalho">

                <div class="esquerdaCabecalho"></div>

                <div class="direitaCabecalho">
                    <img class="sinoIconCabecalho" src="../assets/img/notificacaoIcon.png">
                    <div class="divPerfilCabecalho">
                        <img class="iconPerfilCabecalho" src="../assets/img/fotoPerfil.png">
                        <div class="textosIcon">
                            <p id="tituloPerfil">Anthony Bento</p>
                            <p id="cargoPerfil">CEO</p>
                        </div>
                        <img class="setaPerfilCabecalho" src="../assets/img/setaIcon.png" onclick="exibirMenuPerfil()">
                        <div id="menuPerfil" class="menuPerfil"
                            style="display: none; position: absolute; z-index: 1; top: 58px;">
                            <ul>
                                <button class="btnSair">
                                    <div class="sign"><svg viewBox="0 0 512 512">
                                            <path
                                                d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z">
                                            </path>
                                        </svg></div>

                                    <div class="txtBtn" onclick="limparSessao()">Sair</div>
                                </button>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- fim do cabeçalho -->

            <!-- começo conteudo pagina -->
            <div class="divPaiConteudo">
                <div class="filhoConteudo">

                    <div class="divTitulo">
                        <p id="pTituloSetor">Sala <span id="numSala"></span></p>
                        <p id="pNomeSetor"></p>
                        <p id="pNomeComputador">Máquina <span id="numComputador"></span></p>
                        <button class="btnTrocar" onclick="trocarComputador()">Trocar</button>
                    </div>

                    <div class="divPaiKpi">

                        <div class="divKpi">

                            <div class="barraLateral"></div>

                            <div class="conteudoKpi">
                                <p id="pTituloRede">Ip</p>
                                <p id="pNomeRede"></p>
                                <p id="pIpRede">Rede Conectada</p>
                            </div>

                            <div class="iconKpi">
                                <img id="imgIcon" src="../assets/img/wi-fi.png">
                            </div>

                        </div>

                        <div class="divKpi">

                            <div class="barraLateral"></div>

                            <div class="conteudoKpi">
                                <p id="pTituloRede">Velocidade de Upload</p>
                                <p id="pUploadRede"><span></span></p>
                                <p id="pStatusUpload"></p>
                            </div>

                            <div class="iconKpi">
                                <img id="imgIcon" src="../assets/img/upload-e-download-da-nuvem.png">
                                <img id="iconAjuda" src="../assets/img/ajuda.png" onclick="mostrarModal()">
                            </div>

                        </div>

                        <div class="divKpi">

                            <div class="barraLateral"></div>

                            <div class="conteudoKpi">
                                <p id="pTituloRede">Velocidade de Download</p>
                                <p id="pDownloadRede"><span></span></p>
                                <p id="pStatusDownload"></p>
                            </div>

                            <div class="iconKpi">
                                <img id="imgIcon" src="../assets/img/upload-e-download-da-nuvem.png">
                                <img id="iconAjuda" src="../assets/img/ajuda.png" onclick="mostrarModal()">
                            </div>

                        </div>

                        <div class="divKpi">

                            <div class="barraLateral"></div>

                            <div class="conteudoKpi">
                                <p id="pTituloRede">Ping</p>
                                <p id="pPingRede"><span></span></p>
                                <p id="pStatusPing"></p>
                            </div>

                            <div class="iconKpi">
                                <img id="imgIcon" src="../assets/img/ponto-de-acesso.png">
                                <img id="iconAjuda" src="../assets/img/ajuda.png" onclick="mostrarModal()">
                            </div>

                            <!-- Modal Dialog -->
                            <div id="modal">
                                <div id="modal-content">
                                    <p id="tituloModal">Entenda como os Alertas Funcionam</p>
                                    <div class="espacoModal"></div>
                                    <p id="textoModal">Upload Abaixo de 8 mb: <span id="modalVermelho">↓ Upload
                                            Instável</span></p>
                                    <p id="textoModal">Download Abaixo de 8 mb: <span id="modalVermelho">↓ Download
                                            Instável</span></p>
                                    <p id="textoModal">Ping Abaixo de 10 ms: <span id="modalVermelho">↓ Ping
                                            Instável</span></p>
                                    <div class="espacoModal"></div>
                                    <p id="subModal">Qualquer valor maior que esses aparece como: <span
                                            id="modalVerde">↑ Estável</span></p>
                                    <div class="espacoModalSub"></div>
                                    <p id="subSubModal">valores obtidos com análise em R</p>
                                    <div class="espacoModal"></div>
                                    <button class="btnModal" onclick="fecharModal()">Fechar</button>
                                </div>
                            </div>

                        </div>

                    </div>

                    <div class="divEspaco"></div>

                    <div class="divGraficos">

                        <div class="divDashboard">
                            <canvas id="myChart" style="width:40vh; width:40vw"></canvas>
                        </div>

                        <div class="divAlertas">
                            <canvas id="myChartPing" style="height:70vh; width:40vw;"></canvas>
                            <!-- <p id="tituloAlertas">Histórico Alertas</p>

                            <div class="espaco1"></div>

                            <div class="boxAvisos">
                                <img id="iconAlerta" src="../assets/img/aviso-orange.png">

                                <p id="statusAlerta">Upload Baixo</p>

                                <p id="dataAlerta">02/10/2023 <br> 9:30:14</p>
                            </div>

                            <div class="espaco2"></div>

                            <div class="boxAvisos">
                                <img id="iconAlerta" src="../assets/img/aviso-red.png">

                                <p id="statusAlerta">Upload Baixo</p>

                                <p id="dataAlerta">02/10/2023 <br> 9:30:14</p>
                            </div>

                            <div class="espaco2"></div>

                            <div class="boxAvisos">
                                <img id="iconAlerta" src="../assets/img/aviso-orange.png">

                                <p id="statusAlerta">Upload Baixo</p>

                                <p id="dataAlerta">02/10/2023 <br> 9:30:14</p>
                            </div>

                            <div class="espaco2"></div>

                            <div class="boxAvisos">
                                <img id="iconAlerta" src="../assets/img/aviso-red.png">

                                <p id="statusAlerta">Upload Baixo</p>

                                <p id="dataAlerta">02/10/2023 <br> 9:30:14</p>
                            </div> -->
                        </div>
                    </div>

                </div>
            </div>
            <!-- fim conteudo pagina -->

        </div>
    </div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.5/dist/sweetalert2.all.min.js"></script>
<script>

    window.onload = selectUpload();
    window.onload = selectDownload();
    window.onload = selectPing();
    window.onload = selectIp();
    window.onload = obterMedidasRede();
    window.onload = obterBuscarGraficoPing();

    function mostrarModal() {
        document.getElementById('modal').style.display = 'flex';
    }

    function fecharModal() {
        document.getElementById('modal').style.display = 'none';
    }

    function trocarComputador() {
        window.location = "../setores.html"
    }

    function selectUpload() {
        var idMaquina = sessionStorage.ID_MAQUINA
        fetch(`/usuarios/selectUpload/${idMaquina}`).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    var elementoP = document.getElementById('pUploadRede');
                    pUploadRede.innerHTML = `${resposta.upload} mb`

                    if (resposta.upload >= 8) {
                        pStatusUpload.innerHTML = "↑ Upload Estável"
                    } else {
                        pStatusUpload.innerHTML = "↓ Upload Instável"
                    }

                    if (pStatusUpload.innerHTML == "↑ Upload Estável") {
                        pStatusUpload.style.color = "#1dd800"
                    } else {
                        pStatusUpload.style.color = "#FD3333"
                    }

                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }


    function selectDownload() {
        var idMaquina = sessionStorage.ID_MAQUINA
        fetch(`/usuarios/selectDownload/${idMaquina}`).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    var elementoP = document.getElementById('pUpload');
                    pDownloadRede.innerHTML = `${resposta.download} mb`

                    if (resposta.download >= 8) {
                        pStatusDownload.innerHTML = "↑ Download Estável"
                    } else {
                        pStatusDownload.innerHTML = "↓ Download Instável"
                    }

                    if (pStatusDownload.innerHTML == "↑ Download Estável") {
                        pStatusDownload.style.color = "#1dd800"
                    } else {
                        pStatusDownload.style.color = "#FD3333"
                    }

                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    function selectPing() {
        var idMaquina = sessionStorage.ID_MAQUINA
        fetch(`/usuarios/selectPing/${idMaquina}`).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    var elementoP = document.getElementById('pPingRede');
                    pPingRede.innerHTML = `${resposta.ping} ms`

                    if (resposta.ping <= 10) {
                        pStatusPing.innerHTML = "↑ Ping Estável"
                    } else {
                        pStatusPing.innerHTML = "↓ Ping Instável"
                    }

                    if (pStatusPing.innerHTML == "↑ Ping Estável") {
                        pStatusPing.style.color = "#1dd800"
                    } else {
                        pStatusPing.style.color = "#FD3333"
                    }

                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    function selectIp() {
        var idMaquina = sessionStorage.ID_MAQUINA
        fetch(`/usuarios/selectIp/${idMaquina}`).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    var elementoP = document.getElementById('pNomeRede');
                    pNomeRede.innerHTML = `${resposta.ip}`

                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    function obterMedidasRede(idMaquina) {

        var idMaquina = sessionStorage.ID_MAQUINA

        fetch(`/medidas/tempo-medidasRede/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos da Download: ${JSON.stringify(resposta)}`);

                    plotarGrafico(resposta, idMaquina);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta, idMaquina) {

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [
                {
                    label: 'Upload',
                    data: [],
                    backgroundColor: '#bde5e4',
                    borderColor: '#26ABA7',
                    tension: 0.1
                },
                {
                    label: 'Download',
                    data: [],
                    backgroundColor: '#b7cef1',
                    borderColor: '#115ED2',
                    tension: 0.1
                }
            ]
        };

        let options = {
            plugins: {
                title: {
                    display: true,
                    text: 'Histórico de Velocidade', // Adicione o título desejado aqui
                    font: {
                        size: 16
                    }
                }
            },
        };

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = resposta.length - 1; i >= 0; i--) {
            var registro = resposta[i];
            labels.push(registro.Horário);
            dados.datasets[0].data.push(registro.upload);
            dados.datasets[1].data.push(registro.download);
            console.log(`Registro ${i}: Upload=${registro.upload}, Download=${registro.download}`);
        }

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
            options: options
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChart`),
            config
        );
        setTimeout(() => atualizarGrafico(idMaquina, dados, myChart), 2000);
    }

    function atualizarGrafico(idMaquina, dados, myChart) {

        fetch(`/medidas/atualizarGrafico/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos da atualizar: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico atualizar:`);
                    console.log(dados);

                    // let avisoCaptura = document.getElementById(`avisoCaptura${disco}`)
                    // avisoCaptura.innerHTML = ""

                    if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log('novo upload')
                        console.log(novoRegistro[0].upload)
                        console.log('novo download')
                        console.log(novoRegistro[1].download)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].horario); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].upload); // incluir uma nova medida de umidade
                        dados.datasets[0].data.push(novoRegistro[1].download);

                        // dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        // dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    // proximaAtualizacao = setTimeout(() => atualizarGrafico(disco, dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API Atualizar');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                // proximaAtualizacao = setTimeout(() => atualizarGrafico(disco, dados, myChart), 2000);
            }
        })
            .catch(function
                (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function obterBuscarGraficoPing(idMaquina) {

        var idMaquina = sessionStorage.ID_MAQUINA

        fetch(`/medidas/buscarGraficoPing/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos da GraficoPing: ${JSON.stringify(resposta)}`);

                    plotarGraficoPing(resposta, idMaquina);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGraficoPing(resposta, idMaquina) {

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [
                {
                    label: 'Ping',
                    data: [],
                    backgroundColor: '#bde5e4',
                    borderColor: '#26ABA7',
                    borderWidth: 3
                },
            ]
        };

        let options = {
            plugins: {
                title: {
                    display: true,
                    text: 'Frequência de Ping', // Adicione o título desejado aqui
                    font: {
                        size: 16
                    }
                }
            },
        };

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (let i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.legenda);
            dados.datasets[0].data.push(registro.valor);
            console.log(`Registro ${i}: ping10=${registro.ping10}, ping20=${registro.ping20}, `);
        }

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
            options: options
        };

        // Adicionando gráfico criado em div na tela
        let myChartPing = new Chart(
            document.getElementById(`myChartPing`),
            config
        );
    }

    var cargo = sessionStorage.NIVELACESSO_COLABORADOR;

    if (cargo == "RL") {
        cargo = "Representante"
        SumirCadMaq.style.display = "none";
        SumirAnaliseMaq.style.display = "none";
    } else if (cargo == "GT") {
        cargo = "Gerente TI"
    }
    else {
        cargo = "Equipe TI";
        SumirCadMaq.style.display = "none";
        SumirCadEquipe.style.display = "none";
        SumirAnaliseFunc.style.display = "none";
        divCadastroEquipe.style.top = "18%";
    }

    cargoPerfil.innerHTML = cargo;
    nomeEmpresa.innerHTML = sessionStorage.NOME_FANTASIA_COLABORADOR;
    tituloPerfil.innerHTML = sessionStorage.NOME_COLABORADOR;
    pNomeSetor.innerHTML = sessionStorage.NOME_SETOR;
    numSala.innerHTML = sessionStorage.ID_SALA;
    numComputador.innerHTML = sessionStorage.ID_MAQUINA;

</script>